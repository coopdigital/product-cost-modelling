{% extends 'base.html' %}

{% block content %}
  <div class="modal fade" id="commoditySelection" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Click to add commodities</h4>
        </div>
        <div class="modal-body">
          {% for commodity in commodities %}
            <button type="button" class="btn btn-default btn-lg commodity">{{ commodity.display }}</button>
          {% endfor %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Exit without changes</button>
          <button type="button" class="btn btn-primary">Apply changes</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="chart"></div>
{% endblock %}

{% block js %}
  {{ block.super }}
  <script type="text/javascript">
    var buildComposite = function(dates, blend, priceIndices){
      var compositeIndex = [];
      compositeIndex.length = dates.length
      compositeIndex.fill(0)
      compositeIndex[0] = 'Blend'

      blend.forEach(function(element){
        index = priceIndices[element.display].usd

        for (var i = 1; i < index.length; i++) {
          compositeIndex[i] += element.percentage * index[i]
        }
      });

      return compositeIndex;
    }

    $(function() {
      var dates = {{ dates|safe }};
      var priceIndices = {{ price_indices|safe }};

      var blend = [{
        'display': 'Corn',
        'percentage': 0.2
      }, {
        'display': 'Wheat',
        'percentage': 0.8
      }]

      $('#commoditySelection').modal()

      var composite = buildComposite(dates, blend, priceIndices);

      var chart = c3.generate({
        title: {
          text: 'Indexed Commodity Prices'
        },
        data: {
          x: 'date',
          columns: [
            dates,
            priceIndices['Wheat'].usd,
            priceIndices['Corn'].usd,
            composite
          ]
        },
        axis: {
          x: {
            type: 'timeseries',
            tick: {
              format: '%b \'%y'
            }
          },
          y: {
            tick: {
              format: d3.format('.1f')
            }
          }
        },
        tooltip: {
          format: {
            value: function (value) {
                var format = d3.format('.2f');
                return format(value);
              }
          }
        }
      });

      $('#commoditySelection .commodity').click(function() {
        $(this).toggleClass('btn-success active').blur();
      });

    });
  </script>
{% endblock %}
